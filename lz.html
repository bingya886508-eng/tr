<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•æŠ½é¬¼ç‰Œå¤§ä½œæˆ°</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Confetti for celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f392b; /* Dark Christmas Green */
            background-image: radial-gradient(#1a5c45 1px, transparent 1px);
            background-size: 20px 20px;
            color: white;
            overflow-x: hidden;
        }

        .card-container {
            perspective: 1000px;
        }

        .card {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-front {
            background-color: white;
            color: black;
            transform: rotateY(180deg);
        }

        .card-back {
            background: repeating-linear-gradient(
                45deg,
                #b91c1c,
                #b91c1c 10px,
                #991b1b 10px,
                #991b1b 20px
            );
            border: 2px solid white;
        }

        .suit-red { color: #dc2626; }
        .suit-black { color: #171717; }

        /* Animation for drawing cards */
        @keyframes drawCard {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
            100% { transform: translateY(0) scale(1); }
        }
        
        .animate-draw {
            animation: drawCard 0.5s ease-in-out;
        }

        .snow-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        .winner-glow {
            box-shadow: 0 0 20px #fbbf24;
            border: 2px solid #fbbf24;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Game Configuration & Data ---
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        
        // Potential Prizes
        const PRIZES = [
            { name: "æœ€æ–°æ¬¾ iPhone", icon: "ğŸ“±", rarity: "SSR" },
            { name: "PS5 éŠæˆ²ä¸»æ©Ÿ", icon: "ğŸ®", rarity: "SSR" },
            { name: "é«˜ç´šè—ç‰™è€³æ©Ÿ", icon: "ğŸ§", rarity: "SR" },
            { name: "è–èª•ç¯€é™å®šé¦¬å…‹æ¯", icon: "â˜•", rarity: "R" },
            { name: "ç¥ç§˜ç™¾è²¨ç¦®åˆ¸", icon: "ğŸ«", rarity: "R" },
            { name: "æº«æš–ç¾Šæ¯›åœå·¾", icon: "ğŸ§£", rarity: "R" },
            { name: "è–‘é¤…äººé¤…ä¹¾ä¸€ç›’", icon: "ğŸª", rarity: "N" },
            { name: "è–èª•è€äººçš„ç¥ç¦ (éŠ˜è¬æƒ é¡§)", icon: "ğŸ…", rarity: "N" },
        ];

        // --- Helper Functions ---
        const createDeck = () => {
            let deck = [];
            SUITS.forEach(suit => {
                VALUES.forEach(value => {
                    deck.push({ 
                        id: `${suit}-${value}`, 
                        suit, 
                        value, 
                        isJoker: false,
                        color: (suit === 'â™¥' || suit === 'â™¦') ? 'suit-red' : 'suit-black'
                    });
                });
            });
            // Add Joker
            deck.push({ id: 'JOKER', suit: '', value: 'Joker', isJoker: true, color: 'text-purple-600' });
            return deck;
        };

        const shuffle = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        // Remove pairs (e.g. two 5s)
        const removePairs = (hand) => {
            const counts = {};
            hand.forEach(card => {
                if (card.isJoker) return;
                counts[card.value] = (counts[card.value] || 0) + 1;
            });

            const newHand = [];
            const processedValues = new Set();
            let pairsRemovedCount = 0;

            // Keep Joker
            const joker = hand.find(c => c.isJoker);
            if (joker) newHand.push(joker);

            hand.forEach(card => {
                if (card.isJoker) return;
                
                const count = counts[card.value];
                if (count % 2 !== 0 && !processedValues.has(card.value)) {
                    // If odd count (1 or 3), keep one. Mark as processed so we don't add duplicates if 3 exists
                    newHand.push(card);
                    processedValues.add(card.value);
                } else if (count % 2 === 0) {
                    // Even count (2 or 4), all discarded. Count pairs for stats
                    // Just logic, we don't add to newHand
                }
            });
            
            // Calculate how many pairs were removed for effect
            pairsRemovedCount = (hand.length - newHand.length) / 2;

            return { newHand: shuffle(newHand), pairsRemovedCount };
        };

        // --- Components ---

        const Card = ({ card, faceUp, onClick, isSelectable }) => {
            return (
                <div 
                    className={`card-container w-16 h-24 sm:w-20 sm:h-28 m-1 cursor-pointer ${isSelectable ? 'hover:-translate-y-2' : ''} transition-all duration-200`}
                    onClick={onClick}
                >
                    <div className={`card-inner w-full h-full relative ${faceUp ? 'flipped' : ''}`}>
                        <div className="card-back shadow-md border-2 border-white rounded-lg">
                            <span className="text-2xl opacity-50">ğŸ„</span>
                        </div>
                        <div className="card-front bg-white shadow-md border border-gray-300 rounded-lg flex flex-col justify-between p-1">
                            {card.isJoker ? (
                                <div className="flex flex-col items-center justify-center h-full">
                                    <span className="text-2xl">ğŸ‘»</span>
                                    <span className="text-xs font-bold text-purple-600">JOKER</span>
                                </div>
                            ) : (
                                <>
                                    <div className={`text-left text-sm font-bold ${card.color}`}>{card.value}</div>
                                    <div className={`text-center text-2xl ${card.color}`}>{card.suit}</div>
                                    <div className={`text-right text-sm font-bold ${card.color}`}>{card.value}</div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PrizeModal = ({ isOpen, onDraw, prize }) => {
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white text-gray-900 rounded-xl max-w-sm w-full p-6 text-center shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-green-500 to-red-500"></div>
                        
                        {!prize ? (
                            <>
                                <h2 className="text-2xl font-bold mb-4 text-green-700">ğŸ‰ æ­å–œç²å‹ï¼</h2>
                                <p className="mb-6 text-gray-600">ä½ æˆåŠŸé¿é–‹äº†è¨å­é¬¼ï¼Œè´å¾—äº†è–èª•å¤§çï¼å¿«ä¾†æŠ½çå§ï¼</p>
                                <div className="my-8 text-6xl animate-bounce cursor-pointer" onClick={onDraw}>
                                    ğŸ
                                </div>
                                <button 
                                    onClick={onDraw}
                                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105"
                                >
                                    æŠ½å–è–èª•ç¦®ç‰©
                                </button>
                            </>
                        ) : (
                            <div className="animate-in fade-in zoom-in duration-500">
                                <h3 className="text-xl font-bold text-gray-500 mb-2">ä½ ç²å¾—äº†...</h3>
                                <div className="text-6xl mb-4">{prize.icon}</div>
                                <h2 className="text-3xl font-bold text-red-600 mb-2">{prize.name}</h2>
                                <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold text-white mb-6 ${prize.rarity === 'SSR' ? 'bg-yellow-500' : prize.rarity === 'SR' ? 'bg-purple-500' : 'bg-blue-500'}`}>
                                    {prize.rarity}
                                </span>
                                <br/>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg"
                                >
                                    å†ç©ä¸€æ¬¡
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // States
            const [gameState, setGameState] = useState('menu'); // menu, dealing, playing, finished
            const [turn, setTurn] = useState('player'); // player, cpu
            const [playerHand, setPlayerHand] = useState([]);
            const [cpuHand, setCpuHand] = useState([]);
            const [message, setMessage] = useState('');
            const [winner, setWinner] = useState(null);
            const [showPrizeModal, setShowPrizeModal] = useState(false);
            const [drawnPrize, setDrawnPrize] = useState(null);
            
            // Audio context placeholder (browser blocks autoplay, so we use visual cues mostly)

            // Start Game Logic
            const startGame = () => {
                setGameState('dealing');
                setMessage('æ­£åœ¨æ´—ç‰Œèˆ‡ç™¼ç‰Œ...');
                
                const deck = shuffle(createDeck());
                
                // Distribute cards
                const pHand = [];
                const cHand = [];
                
                deck.forEach((card, i) => {
                    if (i % 2 === 0) pHand.push(card);
                    else cHand.push(card);
                });
                
                setPlayerHand(pHand);
                setCpuHand(cHand);

                // Delay for visual effect then clean pairs
                setTimeout(() => {
                    setMessage('æ­£åœ¨ä¸Ÿæ£„æˆå°çš„ç‰Œ...');
                    cleanPairs(pHand, cHand);
                }, 1500);
            };

            const cleanPairs = (pHand, cHand) => {
                const pResult = removePairs(pHand);
                const cResult = removePairs(cHand);
                
                setPlayerHand(pResult.newHand);
                setCpuHand(cResult.newHand);
                
                setMessage(`ä¸Ÿæ£„äº†æˆå°çš„ç‰Œï¼ä½ ä¸Ÿäº† ${pResult.pairsRemovedCount} å°ï¼Œè–èª•è€äººä¸Ÿäº† ${cResult.pairsRemovedCount} å°ã€‚`);

                setTimeout(() => {
                    setGameState('playing');
                    setTurn('player'); // Player starts
                    setMessage('è¼ªåˆ°ä½ äº†ï¼è«‹é»æ“Šè–èª•è€äººçš„å¡èƒŒä¾†æŠ½ç‰Œã€‚');
                }, 2000);
            };

            // Check Win Condition
            useEffect(() => {
                if (gameState !== 'playing') return;

                if (playerHand.length === 0) {
                    handleGameOver('player');
                } else if (cpuHand.length === 0) {
                    handleGameOver('cpu');
                }
            }, [playerHand, cpuHand, gameState]);

            const handleGameOver = (winr) => {
                setWinner(winr);
                setGameState('finished');
                if (winr === 'player') {
                    setMessage('æ­å–œï¼ä½ è´äº†ï¼é¬¼ç‰Œåœ¨è–èª•è€äººæ‰‹è£¡ï¼');
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    setTimeout(() => setShowPrizeModal(true), 1500);
                } else {
                    setMessage('å™¢ä¸... é¬¼ç‰Œåœ¨ä½ æ‰‹è£¡ï¼Œä½ è¼¸äº†ï¼');
                }
            };

            // CPU Turn Logic
            useEffect(() => {
                if (gameState === 'playing' && turn === 'cpu') {
                    setMessage('è–èª•è€äººæ­£åœ¨æ€è€ƒè¦æŠ½å“ªå¼µç‰Œ...');
                    
                    const timer = setTimeout(() => {
                        // CPU randomly picks a card from Player
                        if (playerHand.length === 0) return;
                        
                        const randomIndex = Math.floor(Math.random() * playerHand.length);
                        const stolenCard = playerHand[randomIndex];
                        
                        // Remove from player
                        const newPlayerHand = [...playerHand];
                        newPlayerHand.splice(randomIndex, 1);
                        setPlayerHand(newPlayerHand);
                        
                        // Add to CPU and check pairs
                        const tempCpuHand = [...cpuHand, stolenCard];
                        const { newHand: cleanCpuHand, pairsRemovedCount } = removePairs(tempCpuHand);
                        
                        setCpuHand(cleanCpuHand);
                        
                        let msg = `è–èª•è€äººæŠ½èµ°äº†ä½ çš„ç‰Œï¼`;
                        if (pairsRemovedCount > 0) msg += ` ä»–æ¹Šæˆäº†ä¸€å°ä¸Ÿæ‰äº†ï¼`;
                        setMessage(msg);
                        
                        setTurn('player');
                    }, 2000); // Wait 2s for "thinking"

                    return () => clearTimeout(timer);
                }
            }, [turn, gameState, playerHand, cpuHand]);

            // Player Action
            const handleDrawCard = (cardIndex) => {
                if (gameState !== 'playing' || turn !== 'player') return;
                
                const stolenCard = cpuHand[cardIndex];
                
                // Remove from CPU
                const newCpuHand = [...cpuHand];
                newCpuHand.splice(cardIndex, 1);
                setCpuHand(newCpuHand);
                
                // Add to Player and check pairs
                const tempPlayerHand = [...playerHand, stolenCard];
                const { newHand: cleanPlayerHand, pairsRemovedCount } = removePairs(tempPlayerHand);
                
                setPlayerHand(cleanPlayerHand);
                
                let msg = `ä½ æŠ½åˆ°äº† ${stolenCard.isJoker ? 'é¬¼ç‰Œ ğŸ‘»' : stolenCard.suit + stolenCard.value}!`;
                if (pairsRemovedCount > 0) msg += ` æ¹Šæˆä¸€å°ä¸Ÿæ‰å›‰ï¼`;
                setMessage(msg);
                
                if (cleanPlayerHand.length > 0) {
                    setTurn('cpu');
                }
            };

            const drawPrize = () => {
                // Simple weighted random or pure random
                // Let's make SSR rare
                const rand = Math.random();
                let selected;
                
                // 10% SSR, 30% SR, 40% R, 20% N
                if (rand < 0.10) selected = PRIZES.filter(p => p.rarity === 'SSR');
                else if (rand < 0.40) selected = PRIZES.filter(p => p.rarity === 'SR');
                else if (rand < 0.80) selected = PRIZES.filter(p => p.rarity === 'R');
                else selected = PRIZES.filter(p => p.rarity === 'N');
                
                const finalPrize = selected[Math.floor(Math.random() * selected.length)];
                
                setDrawnPrize(finalPrize);
                confetti({
                    particleCount: 300,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#FFD700', '#FF0000', '#00FF00']
                });
            };

            return (
                <div className="min-h-screen flex flex-col items-center py-6 px-2 relative">
                    
                    {/* Header */}
                    <header className="text-center mb-6 z-10">
                        <h1 className="text-3xl md:text-5xl font-bold text-red-500 drop-shadow-md bg-white px-4 py-2 rounded-full inline-block">
                            ğŸ… è–èª•æŠ½é¬¼ç‰Œ ğŸƒ
                        </h1>
                        <p className="mt-2 text-green-200 text-sm md:text-base">è´å¾—éŠæˆ²ä¾†æŠ½å–è–èª•ç¦®ç‰©ï¼</p>
                    </header>

                    {/* Game Area */}
                    <main className="flex-1 w-full max-w-5xl flex flex-col justify-between items-center z-10">
                        
                        {gameState === 'menu' && (
                            <div className="flex flex-col items-center justify-center flex-1">
                                <div className="bg-white/10 p-8 rounded-2xl backdrop-blur-md border border-white/20 text-center max-w-md">
                                    <h2 className="text-2xl font-bold mb-4">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                                    <p className="mb-6">è¦å‰‡å¾ˆç°¡å–®ï¼šä¸è¦è®“é¬¼ç‰Œç•™åœ¨æ‰‹ä¸Šï¼<br/>æœ€å¾Œæ‰‹ç‰Œæ¸…ç©ºçš„äººå°±æ˜¯è´å®¶ã€‚</p>
                                    <button 
                                        onClick={startGame}
                                        className="bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-3 px-10 rounded-full shadow-lg transform hover:scale-105 transition"
                                    >
                                        é–‹å§‹éŠæˆ²
                                    </button>
                                </div>
                            </div>
                        )}

                        {(gameState === 'dealing' || gameState === 'playing' || gameState === 'finished') && (
                            <>
                                {/* CPU Hand (Top) */}
                                <div className="w-full mb-4">
                                    <div className="flex justify-center items-center mb-2">
                                        <div className="bg-red-800 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                            ğŸ… è–èª•è€äºº (é›»è…¦)
                                            <span className="bg-red-900 px-2 rounded-full text-xs">{cpuHand.length} å¼µ</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-center flex-wrap min-h-[120px]">
                                        {cpuHand.map((card, index) => (
                                            <Card 
                                                key={`cpu-${index}`} // Index as key because we shuffle often
                                                card={card}
                                                faceUp={false} // CPU cards always face down
                                                isSelectable={gameState === 'playing' && turn === 'player'}
                                                onClick={() => handleDrawCard(index)}
                                            />
                                        ))}
                                    </div>
                                </div>

                                {/* Game Status / Message Area */}
                                <div className="my-4 px-6 py-3 bg-black/40 backdrop-blur-sm rounded-xl border border-white/10 text-center max-w-2xl w-full">
                                    <p className="text-lg md:text-xl font-medium text-yellow-300 animate-pulse">
                                        {message}
                                    </p>
                                    {gameState === 'playing' && (
                                        <div className="text-sm text-gray-300 mt-1">
                                            {turn === 'player' ? "ğŸ‘‡ é»æ“Šä¸Šæ–¹å¡ç‰Œä¾†æŠ½ç‰Œ" : "â³ ç­‰å¾…å°æ‰‹è¡Œå‹•..."}
                                        </div>
                                    )}
                                </div>

                                {/* Player Hand (Bottom) */}
                                <div className="w-full mt-4">
                                    <div className="flex justify-center items-center mb-2">
                                        <div className="bg-green-800 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                            ğŸ‘¤ ä½ çš„æ‰‹ç‰Œ
                                            <span className="bg-green-900 px-2 rounded-full text-xs">{playerHand.length} å¼µ</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-center flex-wrap min-h-[120px]">
                                        {playerHand.map((card) => (
                                            <Card 
                                                key={card.id}
                                                card={card}
                                                faceUp={true}
                                                isSelectable={false}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </main>

                    {/* Prize Modal */}
                    <PrizeModal 
                        isOpen={showPrizeModal} 
                        onDraw={drawPrize} 
                        prize={drawnPrize}
                    />

                    {/* Footer */}
                    <footer className="mt-8 text-xs text-green-200/60 z-10">
                        è–èª•æŠ½é¬¼ç‰Œ Â© 2025
                    </footer>

                    {/* Snow Effect */}
                    <div className="snow-overlay" id="snow"></div>
                </div>
            );
        };

        // Simple Snow JS (Non-React for performance)
        const createSnow = () => {
            const snowContainer = document.getElementById('snow');
            if(!snowContainer) return;
            
            const snowflake = document.createElement('div');
            snowflake.innerHTML = 'â„';
            snowflake.style.position = 'absolute';
            snowflake.style.color = 'white';
            snowflake.style.opacity = Math.random();
            snowflake.style.fontSize = Math.random() * 20 + 10 + 'px';
            snowflake.style.left = Math.random() * window.innerWidth + 'px';
            snowflake.style.animation = `drawCard ${Math.random() * 3 + 2}s linear infinite`; // Reuse animation for fall roughly
            // Actually let's just use CSS transition for falling
            snowflake.style.top = '-20px';
            snowflake.style.transition = `top ${Math.random() * 5 + 3}s linear`;
            
            snowContainer.appendChild(snowflake);

            // Animate fall manually since we didn't add keyframes for falling in CSS block
            requestAnimationFrame(() => {
                snowflake.style.top = window.innerHeight + 'px';
            });

            setTimeout(() => {
                snowflake.remove();
            }, 8000);
        };

        // Easier CSS Snow approach via style injection
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes snowfall {
                0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
                100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
            }
            .snowflake {
                position: absolute;
                top: -10px;
                color: white;
                animation: snowfall linear forwards;
                pointer-events: none;
                z-index: 0;
            }
        `;
        document.head.appendChild(style);

        setInterval(() => {
            const snow = document.createElement('div');
            snow.classList.add('snowflake');
            snow.textContent = Math.random() > 0.5 ? 'â„' : 'â€¢';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.fontSize = Math.random() * 1.5 + 0.5 + 'rem';
            snow.style.opacity = Math.random() * 0.5 + 0.3;
            snow.style.animationDuration = Math.random() * 3 + 5 + 's';
            document.body.appendChild(snow);
            setTimeout(() => snow.remove(), 8000);
        }, 300);

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
